# Problem 60

Consider the following assembly code

```asm
# long loop(long x, int n)
# x in %rdi, n in %esi
loop:
    movl    %esi, %ecx
    movl    $1, %edx
    movl    $0, %eax
    jmp     .L2
.L3:
    movq    %rdi, %r8
    andq    %rdx, %r8
    orq     %r8, %rax
    salq    %cl, %rdx
.L2:
    testq   %rdx, %rdx
    jne     .L3
    rep; ret
```

The preceding code was generated by compiling `C` code that had the following
overall form:

```C
long loop(long x, long n)  {
    long result = ???;
    long mask;
    for (mask = ???; mask ???; mask = ???) {
        result |= ???;
    }
    return result;
}
```

Your task is to fill in the missing parts of the `C` code to get a program equivalent
to the generated assembly code. Recall that the result of the function is returned
in register `%rax`. You will find it helpful to examine the assembly code before,
during and after the loop to form a consistent mapping between the registers and
the program variables.

- (a) Which registers hold program values `x`, `n`, `result`, and `mask`?
- (b) What are the initial values of `result` and `mask`?
- (c) What is the test condition for `mask`?
- (d) How does `mask` get updated?
- (e) How does `result` get updated?
- (f) Fill in the missing parts of the `C` code

## Answers

```asm
# long loop(long x, int n)
# x in %rdi, n in %esi
loop:
    movl    %esi, %ecx      # ecx = n
    movl    $1, %edx        # edx = 1
    movl    $0, %eax        # eax = 0
    jmp     .L2             # goto L2
.L3:
    movq    %rdi, %r8       # r8 = x
    andq    %rdx, %r8       # r8 = r8 & rdx
    orq     %r8, %rax       # rax = rax | r8  (rax | x)
    salq    %cl, %rdx       # rdx = rdx << n (lower 8 bits of esi/n)
.L2:
    testq   %rdx, %rdx      # rdx & rdx
    jne     .L3             # if rdx != 0: goto L3
    rep; ret
```

### (a)

- x: `%rdi`
- n: `%rsi / %esi`
- result: `%rax / %eax`
- mask: `%rdx`

### (b)

- result: 0
- mask: 0

### (c)

- `mask != 0`

### (d)

- `mask <<= n;`

### (e)

- `result |= x & mask;`

### (f)

```C
long loop(long x, long n)  {
    long result = 0;
    long mask;
    for (mask = 1; mask != 0; mask <<= n;) {
        result |= x & mask;
    }
    return result;
}
```
